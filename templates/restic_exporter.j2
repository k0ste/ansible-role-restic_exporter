{{ '## ' + hostvars[inventory_hostname]['restic_exporter_service'] }}
{{ '# ' + ansible_managed }}
{{ '# Do not edit manually' }}

{{ '[Unit]' }}
{{ 'After=network.target network-online.target nss-lookup.target' }}
{{ 'After=docker.service docker.socket' }}
{{ 'Requires=docker.service docker.socket' }}
{{ 'Wants=network-online.target' }}
{{ 'StartLimitIntervalSec=30' }}
{{ 'StartLimitBurst=3' }}

{{ '[Service]' }}
{{ 'Restart=always' }}
{{ 'RestartSec=10' }}
{{ 'ExecStartPre=-' +
  hostvars[inventory_hostname]['restic_exporter_docker_path'] + ' rm -f ' +
  hostvars[inventory_hostname]['restic_exporter_docker_name'] }}
{{ 'ExecStart=' + hostvars[inventory_hostname]['restic_exporter_docker_path'] +
  ' run -p ' ~ lookup('ansible.builtin.vars', 'restic_exporter_port') ~ ':' ~
  lookup('ansible.builtin.vars', 'restic_exporter_port') ~
  ' --pull always --name ' +
  hostvars[inventory_hostname]['restic_exporter_docker_name'] -}}
{% if lookup('ansible.builtin.vars', 'restic_exporter_settings', default='')
  not in ['', [], '[]', None] %}
{% for r in lookup('ansible.builtin.vars', 'restic_exporter_settings') %}
{% include 'restic_settings.j2' %}
{% endfor %}
{% endif %}
{{ ' ngosang/' + hostvars[inventory_hostname]['restic_exporter_docker_name'] +
  ':' + lookup('ansible.builtin.vars', 'restic_exporter_version') }}
{{ 'ExecStop=' + hostvars[inventory_hostname]['restic_exporter_docker_path'] +
  ' stop ' + hostvars[inventory_hostname]['restic_exporter_docker_name'] }}
{{ 'SyslogIdentifier=' +
  hostvars[inventory_hostname]['restic_exporter_docker_name'] }}

{{ '[Install]' }}
{{ 'WantedBy=docker.service' }}
